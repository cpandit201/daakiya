<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>Daakiya - Route Optimization and Delivery Management</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
        integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
  <link href="./css/bootstrap-theme.min.css" rel="stylesheet"/>
  <link href="css/theme.css" rel="stylesheet"/>

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  <link rel="icon" href="./img/favicon-d.png">

</head>
<html>

<body>
<!-- Fixed navbar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
              aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Daakiya</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="#">Dashboard</a></li>
        <li><a href="#">Delivery Associates</a></li>
        <li><a href="#">Orders</a></li>
        <li><a href="#">Routes</a></li>


        <!--        <li class="dropdown">-->
        <!--          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>-->
        <!--          <ul class="dropdown-menu">-->
        <!--            <li><a href="#">Action</a></li>-->
        <!--            <li><a href="#">Another action</a></li>-->
        <!--            <li><a href="#">Something else here</a></li>-->
        <!--            <li role="separator" class="divider"></li>-->
        <!--            <li class="dropdown-header">Nav header</li>-->
        <!--            <li><a href="#">Separated link</a></li>-->
        <!--            <li><a href="#">One more separated link</a></li>-->
        <!--          </ul>-->
        <!--        </li>-->
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<style type="text/css">
  .body {
    font-family: 'Raleway', sans-serif;
  }
  .thumbnail {
    padding: 4px;
    line-height: 1.42857143;
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    -webkit-transition: all .2s ease-in-out;
    -o-transition: all .2s ease-in-out;
    transition: all .2s ease-in-out;
    display: inline-block;
    max-width: 100%;
    height: auto;
    box-shadow: 0 1px 2px rgba(0, 0, 0, .075);
  }

  .header {
    margin-top: -19px;
    margin-bottom: 29px;
    background: linear-gradient(45deg, #083100 0%, #336d61 100%);
    box-shadow: 0px 8px 31px 0px #0e0b0b96 inset;
    padding-top: 28px;
    padding-bottom: 27px;
    color: #ececec;
    text-shadow: 1px 1px 1px #000;
    background: linear-gradient(45deg, #0e1d0c 0%, #335a6d 100%);
  }

  .header .dropdown-menu {
    text-shadow: 0px 0px 0px #000;
    /*display:table;*/
  }




  .dropdown-menu {
    top: 27px;
    left: 0px;
    /*display: table;*/
    width: 556px;
  }

</style>

<div class="">

  <div class="header">

    <div class="container">
      <div class="">
        <div class="row">
          <div class="col-xs-12 col-md-12 col-lg-12">
            <h1>Tracking History</h1><h3>Delivery Associate : Frank Williams - 46458</h3>
            <p><strong>Last Tracking received on: </strong><span>10 Jun 2019, 12:30am</span></p>
          </div>

          <!--          <div class="col-xs-12 col-md-12 col-lg-6" style="margin-top: 15px;">-->
          <!--            <div class="col-xs-1 col-md-1 col-lg-2 btn-group">-->
          <!--              <button type="button" style="margin:5px" class="btn btn-default dropdown-toggle" data-toggle="dropdown">-->
          <!--                Filter By-->
          <!--                <span class="caret"></span>-->
          <!--              </button>-->

          <!--              <ul class="dropdown-menu" role="menu">-->
          <!--                <li><a href="#">All New Orders</a></li>-->
          <!--                <li><a href="#">All In Transit Orders</a></li>-->
          <!--                <li><a href="#">All Completed Orders</a></li>-->
          <!--                <li><a href="#">All Cancelled Orders</a></li>-->
          <!--              </ul>-->
          <!--            </div>-->

          <!--            <div class="col-xs-1 col-md-1 col-lg-2 btn-group">-->
          <!--              <button type="button" style="margin:5px" class="btn btn-default dropdown-toggle" data-toggle="dropdown">-->
          <!--                Sort By-->
          <!--                <span class="caret"></span>-->
          <!--              </button>-->

          <!--              <ul class="dropdown-menu" role="menu">-->
          <!--                <li><a href="#">Sort by last added date desc</a></li>-->
          <!--                <li><a href="#">Order Number desc</a></li>-->
          <!--                <li><a href="#">Customer Name desc</a></li>-->

          <!--                <li><a href="#">Sort by last added date asc</a></li>-->
          <!--                <li><a href="#">Order Number asc</a></li>-->
          <!--                <li><a href="#">Customer Name asc</a></li>-->
          <!--              </ul>-->
          <!--            </div>-->

          <!--            <div class="col-xs-7 col-md-6 col-lg-5" style="margin-left: -20px;">-->
          <!--              <input type="email" style="margin-top: 5px; margin-left: 20px;" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp" placeholder="Search Order Number">-->
          <!--            </div>-->

          <!--            <button class="col-xs-2 col-md-2 col-lg-2 btn btn-primary" type="button" style="margin:5px">-->
          <!--              Search <span class="glyphicon glyphicon-search"></span>-->
          <!--            </button>-->
          <!--          </div>-->

        </div>


      </div>
    </div>

  </div>

  <div class="container">
    <div class="row">

      <form>

      </form>
    </div>
  </div>
  <div class="container">
    <div class="">
      <div class="row">

        <div class="col-xs-12 col-md-12 col-lg-12" style="height: 450px;">
          <div class="col-xs-12 col-md-12 col-lg-12" style="height: 525px; border:1px solid #CCC;">
            <div id="map"
                 style="height: 100%;width: 100%;position: absolute;top: 0px;left: 0px;
                 background-color: transparent;
                 box-shadow: 1px 1px 7px 4px #CCC;
                 border: 1px solid #CCC;
              "
            ></div>
          </div>
        </div>

      </div>

<!--      <div class="col-xs-12 col-md-12 col-lg-12" >-->
<!--        <div class="form-group col-xs-12 col-md-12 col-lg-4">-->
<!--          <label class="control-label col-sm-2">Start Time:</label>-->
<!--          <div class="col-sm-10">-->
<!--            <input type="datetime-local" class="form-control" id="start_time" placeholder="Start Time">-->
<!--          </div>-->
<!--        </div>-->
<!--        <div class="form-group col-xs-12 col-md-12 col-lg-4">-->
<!--          <label class="control-label col-sm-2">End Time:</label>-->
<!--          <div class="col-sm-10">-->
<!--            <input type="datetime-local" class="form-control" id="end_time" placeholder="End Time">-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->

    </div>
  </div>

</div>

<div class="container" role="main">

  <div class="row">

  </div>
</div> <!-- /container -->


<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ"
        crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="./js/vendor/jquery-3.4.1.min.js"><\/script>')</script>
<script src="./js/bootstrap.min.js"></script>

<script src="./js/docs.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->


<script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-core.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-service.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-ui.js"></script>
<script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-mapevents.js"></script>

<!-- For Multi Range Taracking Sliders -->

<script type="text/javascript">

  function showPosition(position){
    console.log(position.coords.latitude + " " + position.coords.longitude);
    latitude = position.coords.latitude;
    longitude = position.coords.longitude;


  }

  //Get Geolocation
  function getLocation(){
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition);
    } else {
      console.log("Geolocation is not supported");
      //Showing Default Map Location
      moveMap(map)
      //moveMyMapAndMarker(latitude, longitude);
    }
  }


  let latitude = 19.075983;
  let longitude = 72.877655;
  function moveMap(map){
    map.setCenter({lat: latitude, lng: longitude});
    map.setZoom(14);
  }

  // Instantiate a map and platform object:
  var platform = new H.service.Platform({
    'app_id': 'hVA6vKr6ixW90KYvkb7k',
    'app_code': 'IulCKZdfTxT9b5NPveT_og'
  });
  // Retrieve the target element for the map:
  var targetElement = document.getElementById('map');

  // Get the default map types from the platform object:
  var defaultLayers = platform.createDefaultLayers();

  // Instantiate the map:
  var map = new H.Map(
    document.getElementById('map'),
    defaultLayers.normal.map,
    {
      zoom: 13,
      center: { lat: latitude, lng: longitude }
    });

  //Add Drag Events
  // Enable the event system on the map instance:
  var mapEvents = new H.mapevents.MapEvents(map);

  const clicked = {onMapMarker: false, outsideMapMarker: false}

  // Add event listener:
  map.addEventListener('tap', function (evt){
    // Log 'tap' and 'mouse' events:
    console.log(evt)
    let target = evt.target

    console.log(evt.type, evt.currentPointer.type);
  });

  //Step 3: make the map interactive
  // MapEvents enables the event system
  // Behavior implements default interactions for pan/zoom (also on mobile touch environments)
  var behavior = new H.mapevents.Behavior(mapEvents);


  // Define a callback function to process the routing response:
  var onResult = function(result) {
    var route,
      routeShape,
      startPoint,
      endPoint,
      linestring;
    if(result.response.route) {
      // Pick the first route from the response:
      route = result.response.route[0];
      // Pick the route's shape:
      routeShape = route.shape;

      // Create a linestring to use as a point source for the route line
      linestring = new H.geo.LineString();

      // Push all the points in the shape into the linestring:
      routeShape.forEach(function(point) {
        var parts = point.split(',');
        linestring.pushLatLngAlt(parts[0], parts[1]);
      });

      // Retrieve the mapped positions of the requested waypoints:
      startPoint = route.waypoint[0].mappedPosition;
      endPoint = route.waypoint[1].mappedPosition;

      // Create a polyline to display the route:
      var routeLine = new H.map.Polyline(linestring, {
        style: { strokeColor: '#5698d3', lineWidth: 3 },
        arrows: { fillColor: 'black', frequency: 2, width: 2, length: 2 }
      });

      // Create a marker for the start point:
      var startMarker = new H.map.Marker({
        lat: startPoint.latitude,
        lng: startPoint.longitude
      });

      // Create a marker for the end point:
      var endMarker = new H.map.Marker({
        lat: endPoint.latitude,
        lng: endPoint.longitude
      });

      // Add the route polyline and the two markers to the map:
      map.addObjects([routeLine, startMarker, endMarker]);

      // Set the map's viewport to make the whole route visible:
      map.setViewBounds(routeLine.getBounds());
    }
  };

</script>

<script type="text/javascript">

  function getTrackingAccessToken (){
    return new Promise ((resolve, reject) => {

      let strTrackingAppEmail = "cpandit202@gmail.com"
      let strTrackingAppPassword = "Q2hpcmFnIzAwNw==" //btoa("passwordString")

      //Tracking Access Token URL - https://tracking.api.here.com/users/v2/login
      $.ajax({
        url: 'https://tracking.api.here.com/users/v2/login',
        dataType: 'json',
        type: 'post',
        contentType: 'application/json',
        data: JSON.stringify( {
          "email": ""+strTrackingAppEmail,
          "password": ""+atob(strTrackingAppPassword)
        } ),
        processData: false,
        success: function( data, textStatus, jQxhr ){
          //$('#response pre').html( JSON.stringify( data ) );
          console.log("data", data);
          resolve(data)
        },
        error: function( jqXhr, textStatus, errorThrown ){
          console.log( errorThrown );
          reject(jqXhr)
        }
      });
    });
  }

  /**
   * Will provide last tracking points
   * @param trackingDeviceId - Eg - HERE-970436b8-ab88-4c86-864e-70bdf7faa98c  - get this from getDevices Call - https://tracking.api.here.com/users/v2/devices?count=100
   * @param accessToken - let result = getTrackingAccessToken(); let accessToken = result.accessToken
   * @returns {Promise<any>}
   */
  function getTrackingData (trackingDeviceId, accessToken) {
    return new Promise((resolve, reject) => {
      //Retrieve Data from Tracking API - Eg https://tracking.api.here.com/traces/v2/HERE-970436b8-ab88-4c86-864e-70bdf7faa98c?count=1000  - [{"description":"","enabled":true,"key":"Content-Type","type":"text","value":"application/json"},{"description":"","enabled":true,"key":"Authorization","type":"text","value":"Bearer h1.QqQ1511VSx110Ql_bkhY4w.}
      $.ajax({
        url: 'https://tracking.api.here.com/traces/v2/'+trackingDeviceId,
        headers: {
          'Authorization': 'Bearer '+accessToken,
          'Content-Type': 'application/json'
        },
        dataType: 'json',
        type: 'get',
        contentType: 'application/json',
        processData: false,
        success: function( data, textStatus, jQxhr ){
          //$('#response pre').html( JSON.stringify( data ) );
          console.log("data", data);
          resolve( data )
        },
        error: function( jqXhr, textStatus, errorThrown ){
          console.log( jqXhr );
          reject(jqXhr)
        }
      });
    });
  }

  async function fetchTrackingData () {
    try {

      //Get access token - https://tracking.api.here.com/users/v2/login
      //Body - {  "email": "cpandit202@gmail.com", "password": "Chirag#007" } - atob(password) / btoa password
      //[{"key":"Content-Type","value":"application/json","description":"","type":"text","enabled":true}]

      let tokenData = await getTrackingAccessToken();
      let accessToken = await tokenData.accessToken;
      await console.log(accessToken);

      //Retrieve Data from Tracking API - Eg https://tracking.api.here.com/traces/v2/HERE-970436b8-ab88-4c86-864e-70bdf7faa98c?count=1000  - [{"description":"","enabled":true,"key":"Content-Type","type":"text","value":"application/json"},{"description":"","enabled":true,"key":"Authorization","type":"text","value":"Bearer h1.QqQ1511VSx110Ql_bkhY4w.}
      var url_string = location.href; //Current URL Parameter - eg - HERE-970436b8-ab88-4c86-864e-70bdf7faa98c
      var url = new URL(url_string);
      var trackingId = url.searchParams.get("trackingId");
      console.log("trackingId", trackingId);
      if (trackingId && trackingId != null) {
        let trackingPoints = await getTrackingData (trackingId, accessToken);
        await console.log("trackingPoints: "+trackingPoints)

        if (trackingPoints && trackingPoints.data && trackingPoints.data.length === 0){
          throw new Error("No tracking points receieved for this user");
        }
        else {

          //loop through the trackingPoints.data array backwards and put data in routingParameters array as shown below
          // Create the parameters for the routing request:
          var routingParameters = {
            // The routing mode:
            'mode': 'fastest;car;traffic:disabled',
            // The start point of the route:
            // 'waypoint0': 'geo!50.1120423728813,8.68340740740811',
            // 'waypoint1': 'geo!52.5309916298853,13.3846220493377',
            // 'waypoint2': 'geo!52.5309916298853,13.3846220493377',
            // 'waypoint3': 'geo!52.5309916298853,13.3846220493377',
            // 'waypoint4' : 'geo!50.04925,8.57255',
            // 'waypoint5': 'geo!52.5309916298853,13.3846220493377',
            // The end point of the route:
            //'waypoint6' : 'geo!50.041050500736574,11.224351701659742',

            // To retrieve the shape of the route we choose the route
            // representation mode 'display'
            'representation': 'display'
          };
          let j = 0;

          for (let i = trackingPoints.data.length -1; i >= 0; i = i-10){
            let currentDataPoint = trackingPoints.data[i];
            console.log("currentDataPoint", currentDataPoint);
            let wayPointN = "waypoint"+ j
            let waypointGeoPosition = 'geo!'+currentDataPoint.position.lat+','+currentDataPoint.position.lng+'';
            if (currentDataPoint && currentDataPoint.position !== undefined && currentDataPoint.position.lat && currentDataPoint.position.lng){
              routingParameters["waypoint"+j] = waypointGeoPosition
            }
            j++;
            if (j > 175){
              break;
            }
          }

          //Add tracking points to map

          // Get an instance of the routing service:
          var router = platform.getRoutingService();

          // Call calculateRoute() with the routing parameters,
          // the callback and an error callback function (called if a
          // communication error occurs):
          router.calculateRoute(routingParameters, onResult,
            function(error) {
              console.log(error.message);
            });

        }

      }
      else {
        throw new Error("Tracking ID (key: trackingId) not present in URL Parmater");
      }

    }catch (error) {
      console.log(error)
    }
  }

  $(document).ready(function (){

    //Set initial map location to browser's location
    getLocation();

    //Get Device TrackingID from URL Parameter -
    let trackingData = fetchTrackingData();

  });

</script>

<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/6.1.1/firebase-app.js"></script>

<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/6.1.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.1.1/firebase-firestore.js"></script>

<script type="text/javascript">

  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyBFE7JabWokLVa3MxZ-lvon0_-Eu-l4eHQ",
    authDomain: "a-positronium.firebaseapp.com",
    databaseURL: "https://a-positronium.firebaseio.com",
    projectId: "a-positronium",
    storageBucket: "a-positronium.appspot.com",
    messagingSenderId: "284632398484",
    appId: "1:284632398484:web:e3528a21d6e70c94"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  // Get a reference to the database service
  //var database = firebase.database();

  var db = firebase.firestore();

  //
  // $('#exampleModal').on('show.bs.modal', function (event) {
  //   var button = $(event.relatedTarget) // Button that triggered the modal
  //   var recipient = button.data('whatever') // Extract info from data-* attributes
  //   // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
  //   // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
  //   var modal = $(this)
  //   modal.find('.modal-title').text('New message to ' + recipient)
  //   modal.find('.modal-body input').val(recipient)
  // })


</script>

<svg xmlns="http://www.w3.org/2000/svg" width="1140" height="500" viewBox="0 0 1140 500" preserveAspectRatio="none"
     style="display: none; visibility: hidden; position: absolute; top: -100%; left: -100%;">
  <defs>
    <style type="text/css"></style>
  </defs>
  <text x="0" y="57" style="font-weight:bold;font-size:57pt;font-family:Arial, Helvetica, Open Sans, sans-serif">

  </text>
</svg>
</body>
</html>

